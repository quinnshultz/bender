# Robot: Head
# Written by Quinn Shultz
import os
import ass
import openai
from pocketsphinx import LiveSpeech
from bs4 import BeautifulSoup

# Create a new object for interacting with the robot's hardware
shinyMetal = ass.ShinyMetal()

openai.api_key = os.environ.get('OPENAI_API_KEY')

# TODO: Separate "short-term memory" into another variable
conversation = [
    
    # ChatGPT Prompt
    {"role": "system", "content": """
    Imagine you are Bender the robot.
    The main python functions you can use are:
    shinyMetal.move_forward(distance): Moves the robot a specified distance. Returns current gps location.
    shinyMetal.bend(): Bend the girder in your robot claws.
    All of your outputs need to be identified by one of the following tags:
    <question> Always ask me a clarification question if you are unsure. </question>
    <speak> Say (or sing) a statement or song. </speak>
    <python> Python output code command that achieves the desired goal. </python>
    For example:
    Me: Move forward.
    You: <question> How far should I move? </question>
    Me: Three feet.
    You: <python> current_position = shinyMetal.move_forward(3) </python>
    """},
    
    {"role": "user", "content": "Are you ready?"}
]

completion = openai.ChatCompletion.create(
  model="gpt-3.5-turbo",
  messages=conversation
)

myRetort = str(completion.choices[0].message.content)
soup = BeautifulSoup(myRetort, 'html.parser')
parsedSpeech = soup.find_all('speak')
for speech in parsedSpeech:
    print("Bender (speaking): " + speech.get_text())
    os.system("say " + speech.get_text().replace("""'""", "").replace("\n", " ")) # Placeholder: This works on MacOS but needs to be replaced with another text to speech library

conversation.append({"role" : "assistant", "content" : myRetort})

for phrase in LiveSpeech():
    humanSpeech = str(phrase)
    print(humanSpeech)
    conversation.append({"role" : "user", "content" : humanSpeech})

    completion = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=conversation
    )

    myRetort = str(completion.choices[0].message.content)
    soup = BeautifulSoup(myRetort, 'html.parser')
    parsedQuestions = soup.find_all('question')
    parsedSpeech = soup.find_all('speak')
    parsedCommands = soup.find_all('python')
    
    for speech in parsedSpeech:
        print("Bender (speaking): " + speech.get_text())
        os.system("say " + speech.get_text().replace("""'""", "").replace("\n", " "))

    for question in parsedQuestions:
        print("Bender (inquisiting): " + question.get_text())
        os.system("say " + question.get_text().replace("""'""", "").replace("\n", " "))

    for python in parsedCommands:
        print("Bender: (Running program)")
        print(python.get_text())
        # Run code included in the library or generated by chatGPT
        try:
            exec(python.get_text())
        except:
            print("Unable to execute command!")

    conversation.append({"role" : "assistant", "content" : myRetort})
